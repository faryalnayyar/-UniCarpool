{% extends "base.html" %}

{% block content %}
<div class="dashboard-container">
    <div class="sidebar">
        <div class="profile-card">
            <div id="profileAvatar" class="profile-avatar">U</div>
            <h3 id="userName">User</h3>
            <p id="userEmail" style="font-size: 0.9em; color: #888;">Loading...</p>
        </div>
        <ul class="menu">
            <li onclick="showSection('search')"><span>ğŸ”</span> Find Rides</li>
            <li onclick="showSection('create')"><span>â•</span> Offer a Ride</li>
            <li onclick="showSection('myrides')"><span>ğŸš—</span> My Rides</li>
            <li onclick="showSection('stats')"><span>ğŸ“Š</span> Driver Stats</li>
        </ul>
    </div>

    <div class="main-content">
        <!-- SEARCH SECTION -->
        <div id="search" class="section active-section">
            <h2>Find a Ride</h2>
            <div class="search-bar">
                <input type="text" id="searchFrom" placeholder="From (e.g. Campus)">
                <input type="text" id="searchTo" placeholder="To (e.g. Downtown)">
                <button onclick="searchRides()" class="action-btn">Search</button>
            </div>

            <div class="geo-search">
                <button onclick="findNearbyRides()" class="secondary-btn">ğŸ“ Find Rides Near Me (Map)</button>
            </div>

            <!-- Map Container -->
            <div id="map-container" style="display:none; margin-top: 15px;">
                <div id="map" style="height: 400px; width: 100%; border-radius: 8px;"></div>
            </div>

            <div id="rideResults" class="rides-grid">
                <!-- Rides injected here -->
            </div>
        </div>

        <!-- Leaflet CSS & JS -->
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
            integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

        <!-- CREATE SECTION -->
        <div id="create" class="section">
            <h2>Offer a Ride</h2>
            <form id="createRideForm" class="create-form">
                <div class="form-row" style="display:flex; gap:10px;">
                    <input type="text" id="cPickup" placeholder="Pickup Location (Type & Search)" required>
                    <button type="button" onclick="searchLocation('pickup')"
                        style="padding:10px; cursor:pointer;">ğŸ”</button>
                </div>
                <div class="form-row" style="display:flex; gap:10px;">
                    <input type="text" id="cDropoff" placeholder="Dropoff Location (Type & Search)" required>
                    <button type="button" onclick="searchLocation('dropoff')"
                        style="padding:10px; cursor:pointer;">ğŸ”</button>
                </div>
                <div class="form-row">
                    <input type="datetime-local" id="cTime" required>
                    <input type="number" id="cSeats" placeholder="Seats" min="1" max="6" required>
                </div>

                <!-- Interactive Map Selection -->
                <div class="map-selection-container" style="margin-bottom: 20px;">
                    <p class="map-instruction" style="font-size: 0.9em; color: #666; margin-bottom: 5px;">
                        ğŸ‘‡ Click on the map to set <b>Pickup (Green)</b> and <b>Dropoff (Red)</b> locations.
                    </p>
                    <div id="selectionMap"
                        style="height: 300px; width: 100%; border-radius: 8px; border: 1px solid #ccc;"></div>
                    <button type="button" onclick="resetSelectionMap()" style="margin-top: 5px; font-size: 0.8em;">â†º
                        Reset Points</button>
                    <small id="selectionStatus" style="color: red; margin-left: 10px;"></small>
                </div>

                <button type="submit" class="submit-btn">Post Ride</button>
            </form>
        </div>

        <!-- MY RIDES SECTION -->
        <div id="myrides" class="section">
            <h2>My Rides</h2>
            <div id="myRidesList" class="rides-list"></div>
        </div>

        <!-- STATS SECTION -->
        <div id="stats" class="section">
            <h2>Driver Statistics</h2>
            <div id="statsList"></div>
            <button onclick="loadStats()" class="secondary-btn">Refresh Stats</button>
        </div>
    </div>
</div>

<script src="/static/js/rides.js"></script>
<script>
    function showSection(id) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active-section'));
        document.getElementById(id).classList.add('active-section');

        // Initialize selection map if offering a ride
        if (id === 'create' && typeof initSelectionMap === 'function') {
            // Small timeout to ensure div is visible for Leaflet size calc
            setTimeout(initSelectionMap, 100);
        }
    }
    // Check auth
    if (!localStorage.getItem('token')) window.location.href = '/auth';
</script>
{% endblock %}